<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>अन्वेषण Anvesana</title>
    <link rel="stylesheet" href="homepage.css">
    <!-- <script src="https://kit.fontawesome.com/bdedc8c31a.js" crossorigin="anonymous"></script> -->
</head>

<body>
    <header>
        <img src="Images/berg.png" alt="Logo">
        <div id="designation-container" class="nav-item"></div>
        <nav>
            <ul>
                <li id="prod-timer" hidden></li>
                <li id="break-timer" hidden>Break Time: 00:00:00</li>
                <span id="timerDisplay"></span>
                <span id="activityDisplay"></span>
                <li id="prod_db">Production:00:00:00</li>
                <li id="break_db">Break: 00:00:00</li>
                <!-- <p style="color: red;" id="running_status"></p> -->
                <button id="sign-out" class="signout">Sign Out</button>
            </ul>
        </nav>
    </header>
    <div>

    </div>
    <div class="container">
        <div id="idlePopup" class="popup">
            <p>You have been idle for 1 minute.</p>
            <button onclick="closePopup()">OK</button>
        </div>
        <div class="form-column">
            <div id="profile-card">
                <h2>Employee Profile</h2>
                <div>Employee Name: <span id="loggedUserName" name="loggedUserName"></span></div>
                <div>Email: <span id="loggedEmailId" name="loggedEmailId"></span></div>
                <div>Employee Id: <span id="loggedEmployeeId" name="loggedEmployeeId"></span></div>
                <div>Process: <span id="loggedProcess" name="loggedProcess"></span></div>
                <div>Timing:
                    <span id="loggedShift" name="loggedShift"></span>
                    <!-- <i id="editShiftIcon" class="fa fa-edit" style="cursor: pointer;"></i> -->
                </div>
                <div>Designation: <span id="designation" name="designation"></span></div>
                <div id="shiftPopup" class="popup">
                    <div class="popup-content">
                        <span class="close-btn">&times;</span>
                        <h2>Update Shift Timing</h2>
                        <select id="shiftDropdown">
                            <option value="">Select Shift</option>
                            <option value="6AM - 3PM">6AM - 3PM</option>
                            <option value="7:30AM - 4:30PM">7:30AM - 4:30PM</option>
                            <option value="9AM - 6PM">9AM - 6PM</option>
                            <option value="10AM - 7PM">10AM - 7PM</option>
                            <option value="12PM - 9PM">12PM - 9PM</option>
                            <option value="1PM - 11PM">1PM - 11PM</option>
                            <option value="3PM - 12AM">3PM - 12AM</option>
                            <option value="9PM - 6AM">9PM - 6AM</option>
                        </select>
                        <button id="updateShiftBtn">Update Shift</button>
                    </div>
                </div>
                <br>
                <br>
            </div>
            <div id="activity-card">
                <form id="contact-form" method="post">
                    <label for="activity">Select your process:</label>
                    <select type="dropdown" name="curr-process" id="curr-process" class="form-control"
                        placeholder="Process" required>
                        <option value="none">Select Process</option>
                        <option value="Flipkart">MPQC:FK</option>
                        <option value="Shopsy">MPQC:Shopsy</option>
                        <option value="Upgrad">UPGRAD</option>
                        <option value="Hitl">HITL</option>
                        <option value="rqa">RQA</option>
                        <option value="ugc">UGC</option>
                        <option value="vsqa">V.SQA</option>
                        <option value="vernac">Vernac</option>
                        <option value="allen">Allen</option>
                        <option value="counter-feit">Counter feit</option>
                        <option value="labelling">Labelling</option>
                        <option value="rsqa">RSQA</option>
                        <option value="ctear trip">Clear Trip</option>
                        <option value="mis">MIS</option>
                        <option value="others">Others</option>
                    </select>
                    <br><br>
                    <select type="dropdown" name="activity" id="activity" class="form-control" placeholder="Activity"
                        required>
                        <option value="none">Select Activity</option>
                        <option value="Production">Production</option>
                        <option value="Break">Tea Break</option>
                        <option value="Break">Bio Break</option>
                        <option value="Break">Lunch Break</option>
                        <option value="Production">Training</option>
                        <option value="Production">Meeting</option>
                    </select>
                    <div class="buttons">
                        <button id="startButton" class="buttontimmer">START</button>
                        <button class="buttontimmer" id="endButton" onclick="setCurrentDate()" disabled>
                            END
                        </button>
                    </div>
                </form>
            </div>

        </div>

        <div class="output-column">
            <h2>Employee Productivity Dashboard</h2>
            <ul id="activityData" hidden></ul>
            <input type="hidden" id="currentDate" name="currentDate">
            <input type="hidden" id="timeDifference" name="timeDifference">
            <input type="hidden" id="id" name="id">
            <input type="hidden" id="name" name="name">
            <input type="hidden" id="process" name="process">
            <input type="hidden" id="startTime" name="startTime">
            <input type="hidden" id="endTime" name="endTime">
            <input type="hidden" id="currentDate" name="currentDate">
            <div id="customAlert">Activity ended</div>
            <div id="customAlerttwo">Activity started</div>

            <div id="graphical-data">
                <div class="chart">
                    <canvas id="myChart" class="myChart"></canvas>

                </div>
                <div class="chart">
                    <canvas id="myCharttwo" class="myChart"></canvas>
                </div>
                <div class="graph-data">
                    <div><span id="prodToday" name="prodToday" hidden></span></div>
                    <div><span id="breToday" name="breToday" hidden></span></div>
                </div>

            </div>
            <div class="chart-two">
                <canvas id="productionChart" width="400" height="250"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>


    <script type="module">

        import { initializeApp } from
            "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
        import { getFirestore, getDoc, updateDoc, doc, query, where, setDoc, addDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDVMhk4-La8nK63C6rsphn16CPWIrmFbmA",
            authDomain: "final-project-8c053.firebaseapp.com",
            projectId: "final-project-8c053",
            storageBucket: "final-project-8c053.appspot.com",
            messagingSenderId: "881972436006",
            appId: "1:881972436006:web:c1df7ce089a267118edae7"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);



        let endTime;

        let productionTotal = 0;
        let breakTotal = 0;
        let timerInterval;
        let prodStartTime;
        let breakStartTime;

        let prodInterval;
        let breakInterval;

        const scriptURL2 = "https://script.google.com/macros/s/AKfycbxpLNJAItDqub4ohM31JsYNPHnA5oHe8u2Eq25WsXYdyEgZJVkiPrzzuTmIYQIfG8HSmQ/exec";
        const scriptURL = 'https://script.google.com/macros/s/AKfycby_-Sg6pPeZC833QU_dM8bH7tSAvQngjz5c0iJlBo-I-cWNdN8BNaU_3WrXfS-gPm7M5g/exec';
        const form = document.forms['contact-form'];


        let currentActivity;
        let currentProcess;
        let startTime;
        let hiddenTime;


        let mpqcfk = 0;
        let mpqcsho = 0;
        let upgrad = 0;
        let hitl = 0;
        let rqa = 0;
        let ugc = 0;
        let vsqa = 0;
        let allen = 0;
        let counter = 0;
        let labelling = 0;
        let rsqa = 0;
        let st = 0;
        let vernac = 0;
        let mis = 0;
        let others = 0;

        onAuthStateChanged(auth, (user) => {
            const loggedInUserId = localStorage.getItem('loggedInUserId');
            if (loggedInUserId) {
                const docRef = doc(db, "users", loggedInUserId);
                getDoc(docRef)
                    .then((docsnap) => {
                        if (docsnap.exists()) {
                            const userData = docsnap.data();
                            document.getElementById('loggedUserName').innerText = userData.username;
                            document.getElementById('loggedEmailId').innerText = userData.email;
                            document.getElementById('loggedEmployeeId').innerText = userData.employeeid;
                            document.getElementById('loggedProcess').innerText = userData.process;
                            document.getElementById('loggedShift').innerText = userData.timings;
                            document.getElementById('designation').innerText = userData.designation;
                            if (userData.designation === "TL") {
                                const clickableText = document.createElement('a');
                                clickableText.href = "tldashboard.html";
                                clickableText.innerText = "TL Dashboard";
                                clickableText.target = "_blank";
                                document.getElementById('designation-container').appendChild(clickableText);
                            }
                        } else {
                            console.log("No document found");
                        }
                    })
            }
        });

        document.addEventListener('DOMContentLoaded', function () {
            const uid = localStorage.getItem('loggedInUserId');
            if (uid) {

            } else {
                window.location.href = 'index.html';
            }
        });





        // document.getElementById('editShiftIcon').addEventListener('click', () => {
        //     document.getElementById('shiftPopup').style.display = 'block';
        // });

        // Close the popup when the close button is clicked
        document.querySelector('.close-btn').addEventListener('click', () => {
            document.getElementById('shiftPopup').style.display = 'none';
        });

        // Update shift timing when the update button is clicked
        document.getElementById('updateShiftBtn').addEventListener('click', () => {
            const selectedShift = document.getElementById('shiftDropdown').value;
            const loggedInUserId = localStorage.getItem('loggedInUserId');

            if (selectedShift && loggedInUserId) {
                const docRef = doc(db, "users", loggedInUserId);

                // Update the shift timing in Firestore
                updateDoc(docRef, {
                    timings: selectedShift
                }).then(() => {
                    // Update the displayed shift timing on the profile card
                    document.getElementById('loggedShift').innerText = selectedShift;
                    alert('Shift timing updated successfully');

                    // Hide the popup after updating
                    document.getElementById('shiftPopup').style.display = 'none';
                }).catch((error) => {
                    console.error("Error updating document: ", error);
                    alert('Failed to update shift timing');
                });
            } else {
                alert('Please select a shift timing');
            }
        });

        // Close the popup when clicking outside of the popup content
        window.onclick = function (event) {
            const popup = document.getElementById('shiftPopup');
            if (event.target == popup) {
                popup.style.display = 'none';
            }
        };

        document.addEventListener('DOMContentLoaded', (event) => {
            const loggedInUserId = localStorage.getItem('loggedInUserId');
            const colRef = collection(db, "EmployeeActivity", loggedInUserId, "activity");
            getDocs(colRef)
                .then((querySnapshot) => {
                    const ul = document.getElementById("activityData");
                    querySnapshot.forEach((doc) => {
                        const activityData = doc.data();
                        const activity = activityData.activity;
                        const difference = activityData.difference;
                        const date = activityData.date;
                        const process = activityData.process;

                        var now = new Date();
                        var year = now.getFullYear();
                        var month = String(now.getMonth() + 1).padStart(2, '0');
                        var day = String(now.getDate()).padStart(2, '0');
                        var formattedDate = year + '-' + month + '-' + day;

                        if (formattedDate == date && activity == "Production" && process == "Upgrad") {
                            upgrad += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "Flipkart") {
                            mpqcfk += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "Shopsy") {
                            mpqcsho += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "Hitl") {
                            hitl += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "rqa") {
                            rqa += parseFloat(difference, 10);
                        }

                        else if (formattedDate == date && activity == "Production" && process == "ugc") {
                            ugc += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "vsqa") {
                            vsqa += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "vernac") {
                            vernac += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "allen") {
                            allen += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "counter-feit") {
                            counter += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "labelling") {
                            labelling += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "rsqa") {
                            rsqa += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "ctear trip") {
                            st += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "mis") {
                            mis += parseFloat(difference, 10);
                        }
                        else if (formattedDate == date && activity == "Production" && process == "others") {
                            others += parseFloat(difference, 10);
                        }
                        else {
                            console.log("No data found!");
                        }
                    });

                    pieChart2(upgrad, mpqcsho, mpqcfk, hitl, rqa, ugc, vsqa, vernac, allen, counter, labelling, rsqa, st, mis, others);
                })
                .catch((error) => {
                    console.error("Error getting documents: ", error);
                });
        });

        document.addEventListener('DOMContentLoaded', (event) => {
            const loggedInUserId = localStorage.getItem('loggedInUserId');
            const colRef = collection(db, "EmployeeActivity", loggedInUserId, "activity");
            getDocs(colRef)
                .then((querySnapshot) => {
                    const ul = document.getElementById("activityData");
                    querySnapshot.forEach((doc) => {
                        const activityData = doc.data();
                        const activity = activityData.activity;
                        const difference = activityData.difference;
                        const date = activityData.date;

                        var now = new Date();
                        var year = now.getFullYear();
                        var month = String(now.getMonth() + 1).padStart(2, '0');
                        var day = String(now.getDate()).padStart(2, '0');
                        var formattedDate = year + '-' + month + '-' + day;

                        if (formattedDate == date) {
                            if (activity == "Production") {
                                productionTotal += parseFloat(difference, 10);
                            }
                            if (activity == "Break") {
                                breakTotal += parseFloat(difference, 10);
                            }
                        }
                        else {
                            console.log("No data found!");
                        }
                    });

                    const hours = Math.floor(productionTotal / 3600);
                    const minutes = Math.floor((productionTotal % 3600) / 60);
                    const secs = productionTotal % 60;

                    const hour = Math.floor(breakTotal / 3600);
                    const minute = Math.floor((breakTotal % 3600) / 60);
                    const sec = breakTotal % 60;

                    let a;
                    let b;
                    a = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                    b = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
                    console.log(a);
                    console.log(b);
                    document.getElementById('prod_db').innerText = 'Production: ' + a;
                    document.getElementById('break_db').innerText = 'Break: ' + b;

                    pieChart(productionTotal, breakTotal);
                    console.log(productionTotal, breakTotal);
                })
                .catch((error) => {
                    console.error("Error getting documents: ", error);
                });
        });

        document.getElementById('sign-out').addEventListener('click', async () => {
            var username = document.getElementById('loggedUserName').innerText;
            var employeeid = document.getElementById('loggedEmployeeId').innerText;
            var process = document.getElementById('loggedProcess').innerText;

            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            var formattedDate = `${year}-${month}-${day}`;
            var formattedTime = now.toTimeString().split(' ')[0];

            const loggedInUserId = localStorage.getItem('loggedInUserId');

            const userConfirmed = confirm('Are you sure you want to sign out? \nYour production data will be submitted.');
            if (userConfirmed) {
                if (loggedInUserId) {
                    if (document.getElementById('startButton').disabled == true) {
                        alert("Please end the activity before Signout");
                    }

                    else {
                        try {
                            const dailyDataDocRef = doc(db, "EmployeeActivity", loggedInUserId, "dailyData", formattedDate);
                            const dailyDataDoc = await getDoc(dailyDataDocRef);
                            if (!dailyDataDoc.exists() || !dailyDataDoc.data().signOutTime) {
                                // Add signOutTime field if it doesn't exist
                                await setDoc(dailyDataDocRef, {
                                    signOutTime: formattedTime
                                }, { merge: true });
                            } else {
                                // Update signOutTime field if it exists
                                await updateDoc(dailyDataDocRef, {
                                    signOutTime: formattedTime
                                });
                            }

                            // Sign out the user
                            await auth.signOut();

                            // Clear local storage and reset timers
                            localStorage.removeItem('prodElapsedTime');
                            localStorage.removeItem('breakElapsedTime');
                            localStorage.removeItem('currentActivity');
                            localStorage.removeItem('startTime');
                            localStorage.removeItem('loggedInUserId');

                            // Clear UI elements
                            document.getElementById('startTime').innerText = '';
                            document.getElementById('endTime').innerText = '';

                            window.location.replace("index.html");
                        } catch (error) {
                            console.error('Error during sign out process:', error);
                            alert('Error signing out. Please try again.');
                        }
                    }
                } else {
                    alert('No user is currently logged in.');
                }


            }
        });


        function saveState() {
            localStorage.setItem('startTime', startTime);
            localStorage.setItem('currentActivity', currentActivity);
            localStorage.setItem('currentProcess', currentProcess);
            localStorage.setItem('activityDropdown', document.getElementById('activity').value);
            localStorage.setItem('processDropdown', document.getElementById('curr-process').value);
            localStorage.setItem('startButtonDisabled', document.getElementById('startButton').disabled);
            localStorage.setItem('endButtonDisabled', document.getElementById('endButton').disabled);
            localStorage.setItem('activityDisabled', document.getElementById('activity').disabled);
            localStorage.setItem('processDisabled', document.getElementById('curr-process').disabled);


        }


        function loadState() {
            startTime = localStorage.getItem('startTime');
            currentActivity = localStorage.getItem('currentActivity');
            currentProcess = localStorage.getItem('currentProcess');

            if (startTime && currentActivity && currentProcess) {
                startTime = new Date(startTime);
                document.getElementById('startTime').innerText = startTime.toLocaleTimeString();
                document.getElementById('activity').value = localStorage.getItem('activityDropdown');
                document.getElementById('curr-process').value = localStorage.getItem('processDropdown');
                document.getElementById('startButton').disabled = (localStorage.getItem('startButtonDisabled') === 'true');
                document.getElementById('endButton').disabled = (localStorage.getItem('endButtonDisabled') === 'true');
                document.getElementById('activity').disabled = (localStorage.getItem('activityDisabled') === 'true');
                document.getElementById('curr-process').disabled = (localStorage.getItem('processDisabled') === 'true');

            }
            if (localStorage.getItem('startTime')) {
                startTime = new Date(localStorage.getItem('startTime'));
                currentActivity = localStorage.getItem('currentActivity');
                currentProcess = localStorage.getItem('currentProcess');

                document.getElementById('activityDisplay').innerText = localStorage.getItem('activity');

                document.getElementById('activity').disabled = true;
                document.getElementById('curr-process').disabled = true;
                document.getElementById('startButton').disabled = true;
                document.getElementById('endButton').disabled = false;

                // Resume the timer
                timerInterval = setInterval(updateTimerDisplay, 1000);
            }
        }

        function checkDropdownValues() {
            const activity = document.getElementById('activity').value;
            const process = document.getElementById('curr-process').value;

            if (activity === 'none' || process === 'none') {
                return false;
            }
            return true;
        }




        document.getElementById('startButton').addEventListener('click', async (event) => {
            event.preventDefault();
            const activity = document.getElementById('activity').value;
            const process = document.getElementById('curr-process').value;
            if (!checkDropdownValues()) {
                alert('Please select process and activity before starting.');
                return;
            }

            startTime = new Date();

            let statusText = "";

            if (activity == "Production") {
                statusText = "Production timer is running";
            } else if (activity == "Break") {
                statusText = "Break timer is running";
            }

            if (activity !== 'none' && process !== 'none') {
                currentActivity = activity;
                currentProcess = process;

                customAlerttwo();
                document.getElementById('endButton').disabled = false;
                document.getElementById('activity').disabled = true;
                document.getElementById('curr-process').disabled = true;
                document.getElementById('startButton').disabled = true;

                // Start the timer
                timerInterval = setInterval(updateTimerDisplay, 1000);


                const loggedInUserId = localStorage.getItem('loggedInUserId');
                const now = new Date();
                const year = now.getFullYear();
                const month = String(now.getMonth() + 1).padStart(2, '0');
                const day = String(now.getDate()).padStart(2, '0');
                const formattedDate = year + '-' + month + '-' + day;

                const docRef = doc(db, "EmployeeActivity", loggedInUserId, "dailyData", formattedDate);

                try {
                    await setDoc(docRef, { currentActivity: activity }, { merge: true });
                    console.log("Current activity added to database");
                } catch (error) {
                    console.error("Error adding current activity to database: ", error);
                }

            }
            document.getElementById('startTime').innerText = startTime.toLocaleTimeString();
            saveState();

        });

        document.getElementById('endButton').addEventListener('click', async (event) => {
            event.preventDefault();
            endActivity();

        });

        function endActivity() {
            let timeDiff;
            const endTime = new Date();
            const formattedEndTime = endTime.toLocaleTimeString();
            const sTime = document.getElementById('startTime').innerText;
            const proc = document.getElementById('curr-process').value;
            // document.getElementById('running_status').innerText = "";
            if (currentActivity !== 'none') {
                currentActivity = 'none';
            }

            document.getElementById('endTime').innerText = formattedEndTime;
            if (startTime) {
                timeDiff = Math.floor((endTime - startTime) / 1000); // Time difference in seconds
                sendTimeToFirebase(sTime, formattedEndTime, timeDiff);
            } else {
                console.error('Start time is not set');
            }

            var username = document.getElementById('loggedUserName').innerHTML;
            var employeeid = document.getElementById('loggedEmployeeId').innerHTML;
            var eTime = document.getElementById('endTime').innerText;
            var a = document.getElementById('activity').value;

            const seconds = timeDiff;
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);

            const formattedHrs = hrs.toString().padStart(2, '0');
            const formattedMins = mins.toString().padStart(2, '0');
            const formattedSecs = secs.toString().padStart(2, '0');

            alert("Activity ended at: " + eTime + "\nDuration is: " + `${formattedHrs}:${formattedMins}:${formattedSecs}`);

            localStorage.removeItem('startTime');
            localStorage.removeItem('currentActivity');
            localStorage.removeItem('currentProcess');
            localStorage.removeItem('activityDropdown');
            localStorage.removeItem('processDropdown');
            localStorage.removeItem('startButtonDisabled');
            localStorage.removeItem('endButtonDisabled');
            localStorage.removeItem('activityDisabled');
            localStorage.removeItem('processDisabled');
            localStorage.removeItem('running_status');

            document.getElementById('activity').disabled = false;
            document.getElementById('startButton').disabled = false;
            document.getElementById('curr-process').disabled = false;
            document.getElementById('endButton').disabled = true;

            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            var formattedDate = year + '-' + month + '-' + day;
            const formData = new FormData();

            formData.append('date', formattedDate);
            formData.append('username', username);
            formData.append('employeeid', employeeid);
            formData.append('process', proc);
            formData.append('activity', a);
            formData.append('start-time', sTime);
            formData.append('end-time', eTime);
            formData.append('duration', timeDiff / (60 * 60));

            fetch(scriptURL, { method: 'POST', body: formData })
                .then(response => {
                    if (response.ok) {
                        console.log("Data sent to sheets");
                    } else {
                        throw new Error('Failed to send data to Google Sheets.');
                    }
                })
                .catch(error => console.error('Error sending data to Google Sheets:', error));

            showAlert();
            const reprodtime = document.getElementById('prod-timer').innerHTML;
            const reproddbtime = document.getElementById('prod_db').innerHTML;

            // Stop the timer
            clearInterval(timerInterval);

            const loggedInUserId = localStorage.getItem('loggedInUserId');
            const docRef = doc(db, "EmployeeActivity", loggedInUserId, "dailyData", formattedDate);
            try {
                setDoc(docRef, { currentActivity: "Idle" }, { merge: true });
                console.log("Current activity set to null in the database");
            } catch (error) {
                console.error("Error setting current activity to null in the database: ", error);
            }

            // Refresh the page after 7 seconds
            setTimeout(() => {
                location.reload();
            }, 7000);

        }

        function updateTimerDisplay() {
            if (startTime) {
                const now = new Date();
                const elapsed = Math.floor((now - startTime) / 1000); // Elapsed time in seconds

                const hrs = Math.floor(elapsed / 3600);
                const mins = Math.floor((elapsed % 3600) / 60);
                const secs = elapsed % 60;

                const formattedHrs = hrs.toString().padStart(2, '0');
                const formattedMins = mins.toString().padStart(2, '0');
                const formattedSecs = secs.toString().padStart(2, '0');

                document.getElementById('timerDisplay').innerText = `${formattedHrs}:${formattedMins}:${formattedSecs}`;
            }
        }

        document.getElementById('activity').addEventListener('change', (event) => {
            const selectedActivity = event.target.value;
            if (selectedActivity !== 'none' && selectedActivity !== currentActivity) {
                if (currentActivity !== 'none') {
                    // stopTimer(currentActivity);
                }
                currentActivity = selectedActivity;
                localStorage.setItem('currentActivity', currentActivity);
            }
        });

        document.getElementById('curr-process').addEventListener('change', (event) => {
            const selectedProcess = event.target.value;
            currentProcess = selectedProcess;
            localStorage.setItem('currentProcess', currentProcess);
        });

        async function fetchProductivityData() {
            const loggedInUserId = localStorage.getItem('loggedInUserId');
            const productivityData = [];
            const dateLabels = [];
            let addProductivity = 0;
            const q = query(collection(db, "EmployeeActivity", loggedInUserId, "activity"));
            const querySnapshot = await getDocs(q);

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.activity === "Production") {
                    const duration = data.difference.split(':');
                    const minutes = parseInt(duration[0], 10);
                    const seconds = parseInt(duration[1], 10);
                    const totalSeconds = (minutes * 60) + seconds;
                    addProductivity += totalSeconds;
                    dateLabels.push(data.date);
                }
            });

            addProductivity = addProductivity / (60 * 60);
            productivityData.push(parseFloat(addProductivity, 10)).toFixed(1);
            return { dateLabels, productivityData };
        }

        function formatTime(date) {
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function calculateTimeDifference(start, end) {
            const startParts = start.split(':');
            const endParts = end.split(':');

            const startHours = parseInt(startParts[0], 10);
            const startMinutes = parseInt(startParts[1], 10);
            const startSeconds = parseInt(startParts[2], 10);

            const endHours = parseInt(endParts[0], 10);
            const endMinutes = parseInt(endParts[1], 10);
            const endSeconds = parseInt(endParts[2], 10);

            // Calculate the total start and end times in seconds
            const totalStartSeconds = (startHours * 3600) + (startMinutes * 60) + startSeconds;
            const totalEndSeconds = (endHours * 3600) + (endMinutes * 60) + endSeconds;

            // Calculate the difference in seconds
            const secondsDiff = totalEndSeconds - totalStartSeconds;

            // Convert seconds to minutes and round to one decimal place
            // const minutesDiff = (secondsDiff / 60);

            return parseFloat(secondsDiff);
        }

        function setCurrentDate() {
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            var formattedDate = year + '-' + month + '-' + day;
            document.getElementById('currentDate').value = formattedDate;
        }

        async function sendTimeToFirebase(start, end, timeDiff) {
            event.preventDefault();

            const activity = document.getElementById("activity").value;
            const date = document.getElementById("currentDate").value;
            const loggedInUserId = localStorage.getItem('loggedInUserId');
            const name = document.getElementById('loggedUserName');
            const proc = document.getElementById('curr-process').value;
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            var formattedDate = year + '-' + month + '-' + day;

            try {
                const docRef = collection(db, "EmployeeActivity", loggedInUserId, "activity");
                // Set data
                await addDoc(docRef, {
                    date: formattedDate,
                    process: proc,
                    activity: activity,
                    uid: loggedInUserId,
                    difference: timeDiff,
                    startTime: start,
                    EndTime: end,
                });

                const dailyRef = doc(db, "EmployeeActivity", loggedInUserId, "dailyData", formattedDate);
                const dailyDoc = await getDoc(dailyRef);
                if (dailyDoc.exists()) {
                    console.log("Data base is there");
                    const data = dailyDoc.data();
                    if (activity === 'Production') {
                        await updateDoc(dailyRef, {
                            production: (data.production || 0) + timeDiff
                        });
                    } else {

                        await updateDoc(dailyRef, {
                            break: (data.break || 0) + timeDiff
                        });
                    }
                } else {
                    console.log("Data base is not there");
                    await setDoc(dailyRef, {
                        date: formattedDate,
                        production: activity === 'Production' ? timeDiff : 0,
                        break: activity !== 'Production' ? timeDiff : 0,
                    });
                }
            } catch (e) {
                console.error("Error writing document: ", e);
            }
        }

        function getDetails() {
            const getId = document.getElementById('loggedEmployeeId').innerText;
            const getName = document.getElementById('loggedUserName').innerText;
            const getProcess = document.getElementById('loggedProcess').innerText;
            document.getElementById('id').value = getId;
            document.getElementById('name').value = getName;
            document.getElementById('process').value = getProcess;
        }


        async function fetchProductionData() {
            const loggedInUserId = localStorage.getItem('loggedInUserId');
            const productionData = [];
            const breakData = [];
            const labels = [];
            const now = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(now.getDate() - i);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const formattedDate = year + '-' + month + '-' + day;

                labels.push(formattedDate);

                const dailyRef = doc(db, "EmployeeActivity", loggedInUserId, "dailyData", formattedDate);
                const dailyDoc = await getDoc(dailyRef);
                if (dailyDoc.exists()) {
                    const data = dailyDoc.data();
                    const productionMinutes = data.production / (60 * 60);
                    const breakMinutes = data.break / (60 * 60);

                    productionData.push(productionMinutes);
                    breakData.push(breakMinutes);
                } else {
                    productionData.push(0);
                    breakData.push(0);
                }
            }
            return { labels, productionData, breakData };
        }



        async function createProductionChart() {
            const ctx = document.getElementById('productionChart').getContext('2d');
            const { labels, productionData, breakData } = await fetchProductionData();

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Production Time (Hours)',
                            data: productionData,
                            backgroundColor: 'purple',
                            borderColor: 'purple',
                            borderWidth: 1
                        },
                        {
                            label: 'Break Time (Hours)',
                            data: breakData,
                            backgroundColor: 'red',
                            borderColor: 'red',
                            borderWidth: 1
                        }
                    ]
                },
                options: {

                    animation: {
                        duration: 1000,
                        easing: 'easeOutBounce'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: false // Hide grid lines on y-axis
                            }

                        },
                        x: {
                            beginAtZero: true,
                            grid: {
                                display: false // Hide grid lines on x-axis
                            }
                        },
                    }

                }
            });
        }

        // Call this function to create the chart
        createProductionChart();



        function pieChart(prod, bre) {

            let totalSeconds = prod + bre;
            let productivityPercentage = (prod / totalSeconds) * 100;
            let breakPercentage = (bre / totalSeconds) * 100;

            const xValues = ["Productivity", "Break"];
            const yValues = [productivityPercentage, breakPercentage];
            const barColors = [
                "#6F40A1",
                "#50E4E4",
            ];

            new Chart("myChart", {
                type: "pie",
                data: {
                    labels: xValues,
                    datasets: [{
                        backgroundColor: barColors,
                        data: yValues
                    }]
                },
                options: {
                    title: {
                        display: true,
                        text: "Productivity and Break Percentages",
                        font: {
                            size: 18 // You can adjust the font size here
                        }
                    },
                    tooltips: {
                        callbacks: {
                            label: function (tooltipItem) {
                                let label = xValues[tooltipItem.index];
                                let value = xValues[0].data[tooltipItem.index];
                                return `${label}: ${value.toFixed(2)}%`;// Ensure % symbol is added here
                            }
                        }
                    }
                }
            });
        }




        function pieChart2(upgrad, shopsy, mpqcfk, hitl, rqa, ugc, vsqa, vernac, allen, counter, labelling, rsqa, st, mis, others) {
            let totalHours = (upgrad + shopsy + mpqcfk + hitl + rqa + ugc + vsqa + vernac + allen + counter + labelling + rsqa + st + mis + others);
            let a = (upgrad / totalHours) * 100;
            let b = (shopsy / totalHours) * 100;
            let c = (mpqcfk / totalHours) * 100;
            let d = (hitl / totalHours) * 100;
            let e = (rqa / totalHours) * 100;
            let f = (ugc / totalHours) * 100;
            let g = (vsqa / totalHours) * 100;
            let h = (vernac / totalHours) * 100;
            let i = (allen / totalHours) * 100;
            let j = (counter / totalHours) * 100;
            let k = (labelling / totalHours) * 100;
            let l = (rsqa / totalHours) * 100;
            let m = (st / totalHours) * 100;
            let n = (mis / totalHours) * 100;
            let o = (others / totalHours) * 100;

            const labels = ["Upgrad", "Shopsy", "Flipkart", "HITL", "RQA", "UGC", "VSQA", "Vernac", "Allen", "Counter", "Labelling", "RSQA", "Clear Trip", "MIS", "Others"];
            const yValues = [a, b, c, d, e, f, g, h, i, j, k, l, m, n, o];
            const barColors = [
                "#FF0000", "#008000", "#0000FF", "#FFA500", "#800080",
                "#FFFF00", "#FFC0CB", "#00FFFF", "#FF00FF", "#00FF00",
                "#A52A2A", "#800000", "#808000", "#000080", "#008080"
            ];

            const filteredData = yValues.map((value, index) => {
                return {
                    label: labels[index],
                    value: value,
                    color: barColors[index]
                };
            }).filter(data => data.value > 0);

            const filteredLabels = filteredData.map(data => data.label);
            const filteredValues = filteredData.map(data => data.value);
            const filteredColors = filteredData.map(data => data.color);

            new Chart("myCharttwo", {
                type: "pie",
                data: {
                    labels: filteredLabels,
                    datasets: [{
                        backgroundColor: filteredColors,
                        data: filteredValues
                    }]
                },
                options: {
                    title: {
                        display: true,
                        text: "Productivity and Break"
                    },
                    plugins: {
                        legend: {
                            display: true, // Show legend only for values that are not zero
                            labels: {
                                filter: function (legendItem, chartData) {
                                    return chartData.datasets[0].data[legendItem.index] > 0;
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    let label = filteredLabels[tooltipItem.dataIndex];
                                    let value = filteredValues[tooltipItem.dataIndex];
                                    return `${label}: ${value.toFixed(2)}%`; // Display percentage with two decimal places
                                }
                            }
                        }
                    }
                }
            });
        }
        document.addEventListener('DOMContentLoaded', loadState);
    </script>
    <script>

        function showAlert() {
            const alertBox = document.getElementById('customAlert');
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }


        function customAlerttwo() {
            const alertBox = document.getElementById('customAlerttwo');
            alertBox.style.display = 'block';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 3000);
        }
        function setCurrentDate() {
            var now = new Date();
            var year = now.getFullYear();
            var month = String(now.getMonth() + 1).padStart(2, '0');
            var day = String(now.getDate()).padStart(2, '0');
            var formattedDate = year + '-' + month + '-' + day;
            document.getElementById('currentDate').innerText = formattedDate;
        }
    </script>
    <!-- <script>
        let idleTime = 0;
        let idleInterval;
        let idleLimit = 60; // 1 minute
        let idlePopup = document.getElementById("idlePopup");
        let lastActivityTime = Date.now();

        // Retrieve stored idle time if available
        if (localStorage.getItem("idleTime")) {
            idleTime = parseInt(localStorage.getItem("idleTime"), 10);
        }

        // Retrieve stored last activity time if available
        if (localStorage.getItem("lastActivityTime")) {
            lastActivityTime = parseInt(localStorage.getItem("lastActivityTime"), 10);
            const currentTime = Date.now();
            idleTime += Math.floor((currentTime - lastActivityTime) / 1000);
            lastActivityTime = currentTime;
        }

        function resetIdleTime() {
            idleTime = 0;
            lastActivityTime = Date.now();
            localStorage.setItem("idleTime", idleTime);
            localStorage.setItem("lastActivityTime", lastActivityTime);
            broadcastActivity();
        }

        function startIdleTimer() {
            idleInterval = setInterval(timerIncrement, 1000);
            lastActivityTime = Date.now();
            localStorage.setItem("lastActivityTime", lastActivityTime);
        }

        function stopIdleTimer() {
            clearInterval(idleInterval);
        }

        function timerIncrement() {
            const currentTime = Date.now();
            idleTime = Math.floor((currentTime - lastActivityTime) / 1000);
            localStorage.setItem("idleTime", idleTime);

            if (idleTime >= idleLimit) {
                idlePopup.style.display = "block";
                stopIdleTimer();
            }
        }

        function closePopup() {
            idlePopup.style.display = "none";
            resetIdleTime();
            startIdleTimer();
        }

        function broadcastActivity() {
            localStorage.setItem("activityEvent", Date.now());
        }

        // Event listeners to detect user activity
        document.onmousemove = resetIdleTime;
        document.onkeypress = resetIdleTime;
        document.onscroll = resetIdleTime;
        document.onclick = resetIdleTime;

        // Page Visibility API to handle tab visibility changes
        document.addEventListener("visibilitychange", function () {
            if (document.hidden) {
                stopIdleTimer();
            } else {
                startIdleTimer();
            }
        });

        // Save the idle time to localStorage before the user leaves the page
        window.addEventListener("beforeunload", function () {
            localStorage.setItem("idleTime", idleTime);
            localStorage.setItem("lastActivityTime", lastActivityTime);
        });

        // Listen for storage events to synchronize activity across tabs
        window.addEventListener("storage", function (event) {
            if (event.key === "activityEvent") {
                resetIdleTime();
            }
        });

        // Start the idle timer when the page loads
        startIdleTimer();
    </script> -->
</body>

</html>